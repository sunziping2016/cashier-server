<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>models/hooks.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-src_models_jwt-Jwt.html">Jwt</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-src_models_jwt-Jwt.html#getSecretKey">getSecretKey</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-src_models_jwt-Jwt.html#revoke">revoke</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-src_models_jwt-Jwt.html#setSecretKey">setSecretKey</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-src_models_jwt-Jwt.html#sign">sign</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-src_models_jwt-Jwt.html#verify">verify</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-src_models_jwt-RevokedError.html">RevokedError</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-src_models_users-Permission.html">Permission</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-src_models_users-Role.html">Role</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-src_models_users-User.html">User</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-src_models_users-User.html#checkPassword">checkPassword</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-src_server-Server.html">Server</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-src_server-Server.html#start">start</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-src_server-Server.html#stop">stop</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-src_koa-logger.html">src/koa-logger</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-src_koa-logger.html#~koaLogger">koaLogger</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-src_models_hooks.html">src/models/hooks</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-src_models_hooks.html#~addDeleted">addDeleted</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-src_models_hooks.html#~addFileFields">addFileFields</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-src_models_jwt.html">src/models/jwt</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-src_models_users.html">src/models/users</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-src_server.html">src/server</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-src_utils.html">src/utils</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-src_utils.html#~randomAlnumString">randomAlnumString</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">models/hooks.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";
var __awaiter = (this &amp;&amp; this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this &amp;&amp; this.__importDefault) || function (mod) {
    return (mod &amp;&amp; mod.__esModule) ? mod : { "default": mod };
};
var __importStar = (this &amp;&amp; this.__importStar) || function (mod) {
    if (mod &amp;&amp; mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Some common hooks (aka middleware) for mongoose.
 *
 * @module src/models/hooks
 */
const fs_1 = __importDefault(require("fs"));
const mongoose_1 = require("mongoose");
const path_1 = __importDefault(require("path"));
const util_1 = __importStar(require("util"));
const winston_1 = __importDefault(require("winston"));
const unlinkAsync = util_1.default.promisify(fs_1.default.unlink);
function parseUpdateArguments(conditions, doc, options, callback) {
    if (typeof options === 'function') {
        // .update(conditions, doc, callback)
        callback = options;
        options = null;
    }
    else if (typeof doc === 'function') {
        // .update(doc, callback);
        callback = doc;
        doc = conditions;
        conditions = {};
        options = null;
    }
    else if (typeof conditions === 'function') {
        // .update(callback)
        callback = conditions;
        conditions = undefined;
        doc = undefined;
        options = undefined;
    }
    else if (typeof conditions === 'object' &amp;&amp; !doc &amp;&amp; !options &amp;&amp; !callback) {
        // .update(doc)
        doc = conditions;
        conditions = undefined;
        options = undefined;
        callback = undefined;
    }
    return [conditions, doc, options, callback];
}
/**
 * Add a soft-delete hook. It can only be triggered by `delete` and `restore`
 * (including both class method and instance method), and is only visible to
 * `estimatedDocumentCount`, `countDocuments`, `find`, `findOne`,
 * `findOneAndUpdate`, `updateOne`, `updateMany` and their `*Deleted` and
 * `*WithDeleted` variants.
 *
 * @param schema {mongoose.Schema} schema to add soft-delete hook.
 */
function addDeleted(schema) {
    for (const method of [
        'estimatedDocumentCount',
        'countDocuments',
        'find',
        'findOne',
    ]) {
        schema.statics[method] = function () {
            return mongoose_1.Model[method]
                .apply(this, arguments)
                .where('deleted')
                .ne(true);
        };
        schema.statics[method + 'Deleted'] = function () {
            return mongoose_1.Model[method]
                .apply(this, arguments)
                .where('deleted')
                .equals(true);
        };
        schema.statics[method + 'WithDeleted'] = function () {
            return mongoose_1.Model[method].apply(this, arguments);
        };
    }
    for (const method of [
        'findOneAndUpdate',
        'updateOne',
        'updateMany',
    ]) {
        schema.statics[method] = function () {
            const args = parseUpdateArguments.apply(undefined, arguments);
            args[0] = args[0] || {};
            args[0].deleted = { $ne: true };
            return mongoose_1.Model[method].apply(this, args);
        };
        schema.statics[method + 'Deleted'] = function () {
            const args = parseUpdateArguments.apply(undefined, arguments);
            args[0] = args[0] || {};
            args[0].deleted = { $eq: true };
            return mongoose_1.Model[method].apply(this, args);
        };
        schema.statics[method + 'WithDeleted'] = function () {
            return mongoose_1.Model[method].apply(this, arguments);
        };
    }
    schema.methods.delete = function () {
        this.deleted = true;
        return this.save();
    };
    schema.statics.delete = function (conditions, callback) {
        if (typeof conditions === 'function') {
            callback = conditions;
            conditions = {};
        }
        return this.updateManyWithDeleted(conditions, { deleted: true }, callback);
    };
    schema.methods.restore = function () {
        this.deleted = false;
        return this.save();
    };
    schema.statics.restore = function (conditions, callback) {
        if (typeof conditions === 'function') {
            callback = conditions;
            conditions = {};
        }
        return this.updateManyWithDeleted(conditions, { deleted: false }, callback);
    };
}
exports.addDeleted = addDeleted;
/**
 * Add a hook to schema to automatically delete file when no field refers to it.
 * This hook only work for `save` and `remove`, and you cannot call `save` and
 * `remove` multiple times.
 *
 * @param schema {mongoose.Schema} schema to add file fields hook.
 * @param fields {string[]} array of field names.
 * @param uploadDir {string} base directory for files.
 */
function addFileFields(schema, fields, uploadDir) {
    function errLogger(filename) {
        return (err) => {
            if (err) {
                winston_1.default.error(`Failed to delete file "${filename}".`);
                winston_1.default.error(err);
            }
        };
    }
    schema.post('init', doc => {
        for (const field of fields) {
            // @ts-ignore
            doc['_' + field] = doc[field];
        }
    });
    schema.post('save', (doc) => __awaiter(this, void 0, void 0, function* () {
        for (const field of fields) {
            // @ts-ignore
            const oldFilename = doc['_' + field];
            try {
                // @ts-ignore
                if (oldFilename &amp;&amp; oldFilename !== doc[field])
                    yield unlinkAsync(path_1.default.join(uploadDir, oldFilename));
            }
            catch (e) {
                errLogger(oldFilename)(e);
            }
        }
    }));
    schema.post('remove', (doc) => __awaiter(this, void 0, void 0, function* () {
        for (const field of fields) {
            // @ts-ignore
            const oldFilename = doc['_' + field];
            try {
                // @ts-ignore
                if (oldFilename)
                    yield unlinkAsync(path_1.default.join(uploadDir, oldFilename));
            }
            catch (e) {
                errLogger(oldFilename)(e);
            }
        }
    }));
}
exports.addFileFields = addFileFields;
function addSearchMethod(schema, exclude) {
    schema.statics.searchAsync = util_1.promisify(schema.statics.search);
    schema.statics.paths = Object.keys(schema.paths).filter(x => !exclude.has(x));
}
exports.addSearchMethod = addSearchMethod;
//# sourceMappingURL=hooks.js.map</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Sun Jan 12 2020 02:29:01 GMT+0000 (Coordinated Universal Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
